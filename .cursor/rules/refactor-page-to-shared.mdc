---
description: Рефакторинг страницы из src/pages — вынос логики в src/shared и переиспользование существующих общих модулей
globs: src/pages/**/*
alwaysApply: false
---

# Рефакторинг модуля страницы: вынос в shared и переиспользование

## 1. Назначение правила

**Когда это правило в контексте чата вместе с файлом или папкой из `src/pages`:**

- Пользователь хочет улучшить архитектуру **конкретного модуля страницы**, который он добавил в чат.
- Задача агента: отредактировать этот модуль так, чтобы:
  1. **Переиспользовать** уже существующие части из `src/shared` (UI, API, lib, i18n), а не дублировать логику.
  2. **Вынести** повторяемую или общую логику из страницы в `src/shared`, если такой логики там ещё нет.
- Итог: изменённый модуль страницы, соответствующий лучшим практикам архитектуры проекта и максимально опирающийся на `src/shared`.

**Целевой слой для правок:** файлы в `src/pages` (страницы, их утилиты в той же папке). Дополнительно при необходимости: новые или изменённые файлы в `src/shared`.

---

## 2. Контекст проекта: что уже есть в `src/shared`

Перед рефакторингом агент должен учитывать существующие модули. При необходимости — прочитать соответствующие файлы.

### 2.1. `src/shared/ui`

- **Alert** — сообщения (error, success, info).
- **ConfirmModal** — диалог подтверждения (onConfirm, onCancel, сообщение).
- **FormActions** — кнопки отправки/отмены формы (submitLabel, submitting, cancelLabel, onCancel или cancelTo).
- **FormGroup** — обёртка label + поле (label, htmlFor, children).
- **FormPageLayout** — страница формы с заголовком, ошибкой и form.
- **Modal** — универсальная модалка (open, onClose, title, variant: form и т.д.).
- **PageMessage** — сообщение на странице.

**Действие:** все кнопки «Сохранить/Отмена», модалки подтверждения, блоки ошибок, обёртки полей форм должны использовать эти компоненты. Не создавать дублирующие разметку/логику в странице.

### 2.2. `src/shared/lib`

- **truncate** — обрезка строки по длине.
- **getDisplayName(firstName, lastName, email)** — отображаемое имя пользователя из полей профиля.
- **getAssessmentTypeDisplayName**, **KNOWN_ASSESSMENT_TYPE_CODES** — типы оценивания.

**Действие:** любая логика «как показать имя пользователя», обрезка текста, работа с типами оценивания — через эти функции. Не дублировать реализацию в странице.

### 2.3. `src/shared/api`

- **client**: request, API_BASE, setSessionExpiredHandler, ErrorResponse.
- **auth** — авторизация.
- **invitations** — приглашения (validateToken, acceptInvitation, listInvitations, createInvitation и т.д.).
- **account**: getMe, patchMe, listUsers, getUser, patchUser, deleteUser, listTeachers, listStudents.
- **types** — DTO (UserDto, StudentProfileItem, TeacherProfileItem, InvitationDto и т.д.).

**Действие:** работа с пользователями, студентами, преподавателями, приглашениями, сессией — только через `src/shared/api`. Не дублировать запросы и типы в странице или в entities, если они уже есть в shared/api.

### 2.4. `src/shared/i18n`

- **useTranslation(ns)** — ключи перевода по неймспейсу (dashboard, common, auth и т.д.).
- **formatDate**, **formatDateTime**, **formatTime** — форматирование дат с учётом локали.
- **Locale**, **NAMESPACES** — конфиг локалей и неймспейсов.

**Действие:** все подписи, сообщения об ошибках, даты в UI — через `useTranslation` и форматтеры из shared/i18n. Не хардкодить строки и не дублировать форматирование дат.

### 2.5. `src/shared/types`, `src/shared/config`

- Общие типы и конфиг приложения. Использовать при необходимости вместо локальных определений в странице.

### 2.6. Виджеты (не в shared, но общий слой)

- **EntityViewLayout** (`src/widgets/entity-view-layout`) — страница просмотра сущности: loading, notFound, error, backTo, title, onEditClick, viewOnly.
- **EntityListLayout** (`src/widgets/entity-list-layout`) — страница списка: title, search, createTo/createLabel, error/success, viewOnly.
- **FormPageLayout** — в shared/ui.

**Действие:** страницы «просмотр одной сущности» и «список сущностей» должны использовать эти лейауты, а не собирать такую же разметку вручную.

---

## 3. Алгоритм действий агента

Выполнять по шагам. Не пропускать шаг «проверка переиспользования».

### Шаг 1. Определить целевой модуль

- Целевой модуль — файл(ы) из `src/pages`, которые пользователь добавил в контекст (или явно указал).
- Если добавлена папка (например, `src/pages/dashboards/admin/groups`) — целевой модуль: все страницы и при необходимости `utils.ts` в этой папке.

### Шаг 2. Сканирование на переиспользование (обязательно)

- Прочитать импорты и тело целевого модуля.
- Для каждого фрагмента логики или UI задать вопрос: «Есть ли уже в `src/shared` или в `src/widgets` готовый компонент/функция/API?»
- Проверить по спискам выше:
  - Кнопки Submit/Cancel, модалки, алерты, поля форм → shared/ui.
  - Имена пользователей, обрезка строк, типы оценивания → shared/lib.
  - Запросы к пользователям/студентам/преподавателям/приглашениям → shared/api.
  - Тексты и даты → shared/i18n.
  - Страница просмотра/списка → EntityViewLayout / EntityListLayout.
- Составить список замен: «вместо X в странице использовать Y из shared/widgets».

### Шаг 3. Выявление логики для выноса в shared

- Найти в целевом модуле:
  - **Дублирование:** логика или разметка, которая уже есть в другой странице или в shared (тогда только заменить на использование shared).
  - **Повторяемость:** логика, которая может пригодиться ещё на других страницах (форматирование, расчёт, маппинг полей для отображения).
- Критерии выноса:
  - Функция/компонент не привязана к одной сущности/странице и может быть названа обобщённо.
  - Вынос не ломает границы слоёв: страница может зависеть от shared, shared не должен зависеть от конкретной страницы или entity.
- Решение: выносить в `src/shared/lib` (утилиты), `src/shared/ui` (компоненты) или оставить в странице, если логика сугубо специфична.

### Шаг 4. Внесение изменений

1. **Сначала** заменить дублирующий код на использование существующих модулей из `src/shared` и виджетов (см. раздел 2).
2. **Затем** при необходимости вынести новую общую логику в `src/shared` и обновить экспорты (например, в `shared/lib/index.ts` или `shared/ui/index.tsx`).
3. **В конце** обновить целевой модуль страницы: оставить только композицию (данные, вызовы entity API, shared API, shared UI, виджеты, i18n).

### Шаг 5. Проверка результата

- В целевом модуле нет дублирования того, что уже есть в shared/widgets.
- Импорты из `src/shared` и виджетов используются по назначению.
- Новая логика в shared — без обратных зависимостей на страницы или конкретные entity (при необходимости типы — общие или из shared/types/api).

---

## 4. Паттерны проектирования и принципы

### 4.1. DRY (Don't Repeat Yourself)

- Одна и та же логика (например, «имя пользователя из firstName/lastName/email») должна существовать в одном месте — в `src/shared/lib` или `src/shared/api/types`.
- Если в странице есть локальная функция, совпадающая по смыслу с shared — удалить её и импортировать из shared (при необходимости адаптировать аргументы тонкой обёрткой в той же странице или в shared).

### 4.2. Единая ответственность страницы

- Страница отвечает за: маршрут, сбор данных (entity API + shared API), состояние UI страницы, композицию виджетов и shared-компонентов.
- Страница не должна содержать: полную реализацию форматирования дат, построение имён пользователей, универсальные модалки подтверждения, обёртки полей форм — это зона shared/ui и shared/lib.

### 4.3. Композиция вместо дублирования разметки

- Использовать EntityViewLayout / EntityListLayout для единообразного каркаса (заголовок, кнопка «Назад», «Редактировать», поиск, создание).
- Внутри — shared/ui (Alert, FormGroup, Modal, ConfirmModal, FormActions) и контент, специфичный для страницы.

### 4.4. Импорты и зависимости

- Страница может импортировать: `entities/*`, `shared/*`, `widgets/*`, `app/hooks/*`, react-router, react.
- `src/shared` не должен импортировать из `src/pages` или из конкретных `entities/*` (кроме общих типов, если они вынесены в shared/types). Entities могут использоваться в странице для доменной логики и API сущностей; общие запросы (пользователи, студенты, учителя) — из shared/api.

### 4.5. Именование при выносе

- В `shared/lib`: имена функций/констант — общие (getDisplayName, truncate, formatX).
- В `shared/ui`: компоненты с ясным назначением (ConfirmModal, FormActions, FormGroup).
- Не выносить в shared сущностно-специфичные имена без обобщения (например, «groupMemberDisplayName» можно обобщить до функции по полям user/student и положить в shared/lib или оставить тонкую обёртку в странице, вызывающую getDisplayName).

### 4.6. Типы

- Типы, используемые только одной страницей, могут оставаться в ней или в локальном `utils.ts` папки страницы.
- Типы, используемые в shared (API, несколько страниц), должны быть в `shared/types` или в типах `shared/api`.

---

## 5. Чек-лист переиспользования (пройти по модулю)

- [ ] Все сообщения об ошибках/успехе и подписи — через `useTranslation` (shared/i18n).
- [ ] Форматирование дат — через `formatDate` / `formatDateTime` / `formatTime` (shared/i18n).
- [ ] Отображение имени пользователя (ФИО/email) — через `getDisplayName` или существующий helper из shared/lib; обрезка строк — через `truncate`.
- [ ] Запросы к пользователям, студентам, преподавателям, приглашениям — через `src/shared/api`, не дублировать fetch/типы.
- [ ] Кнопки «Сохранить»/«Отмена» в формах — через `FormActions` или явно по дизайну shared/ui.
- [ ] Модалки подтверждения удаления/действия — `ConfirmModal`.
- [ ] Произвольные модалки с формой — `Modal` (variant="form") + `FormGroup` при необходимости.
- [ ] Алерты — компонент `Alert`.
- [ ] Страница просмотра одной сущности — `EntityViewLayout`; страница списка — `EntityListLayout`.
- [ ] Страница создания/редактирования с одной формой — при необходимости `FormPageLayout` из shared/ui.

---

## 6. Куда выносить новую логику

| Тип логики | Куда выносить | Пример |
|------------|----------------|--------|
| Форматирование строк, расчёт отображаемого значения по данным | `src/shared/lib` | displayName, truncate, assessmentTypeDisplayName |
| Переиспользуемый UI-блок (кнопки, модалка, обёртка поля) | `src/shared/ui` | FormActions, ConfirmModal, FormGroup |
| Запрос к API, общий для нескольких экранов | `src/shared/api` (или оставить в entity, если сущностный) | listStudents, getUser в shared/api |
| Общие типы для API/нескольких страниц | `src/shared/types` или типы в `shared/api` | — |
| Специфичная для одной страницы логика | Оставить в странице или в `utils.ts` папки страницы | — |

---

## 7. Краткий итог для агента

1. **Вход:** правило в контексте + файл или папка из `src/pages`.
2. **Цель:** рефакторинг этого модуля страницы с опорой на `src/shared` и виджеты.
3. **Порядок:** (1) определить целевой модуль → (2) проверить переиспользование всего из раздела 2 → (3) найти кандидатов на вынос в shared → (4) применить замены и вынос → (5) проверить чек-лист и зависимости.
4. **Результат:** изменённый модуль в `src/pages`, при необходимости новые/изменённые файлы в `src/shared`, без дублирования и с явным использованием существующих shared-модулей.
